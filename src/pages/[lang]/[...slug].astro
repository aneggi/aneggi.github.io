---
import { type CollectionEntry, getCollection } from 'astro:content';
import Prose from '@src/components/Prose.astro';
import BaseLayout from '@src/layouts/BaseLayout.astro';
import { Image } from 'astro:assets';
import FormattedDate from '@src/components/FormattedDate.astro';
import AboutTheAuthor from '@src/components/widgets/AboutTheAuthor.astro';
import TableOfContent from '@src/components/widgets/TableOfContent.astro';
import { slugify } from '@src/utils';
import { loadEnv } from 'vite';
import { render } from 'astro:content';
import { resolveLang, withLangPrefix, stripLangFromSlug } from '@src/i18n/config';
import { getUiCopy } from '@src/i18n/ui';

const { GISCUS_REPO, GISCUS_REPO_ID, GISCUS_CATEGORY, GISCUS_CATEGORY_ID } = loadEnv(process.env.NODE_ENV || 'production', process.cwd(), '');

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post: any) => ({
    params: {
      lang: post.data.lang,
      slug: stripLangFromSlug(post.slug || post.id) || post.id,
    },
    props: post
  }));
}
type Props = CollectionEntry<'blog'>;
const post = Astro.props;
const {
	data: { title, seoTitle, description, coverImage, date, updatedDate, tags }
} = post;
const { Content, headings } = await render(post);
const lang = resolveLang(Astro.params.lang);
const copy = getUiCopy(lang);
const cleanSlug = stripLangFromSlug(post.slug || post.id) || post.id;
const translationKey = post.data.translationOf || cleanSlug;
const allPosts = await getCollection('blog');
const alternate = allPosts.find((entry) => (entry.data.translationOf || stripLangFromSlug(entry.slug)) === translationKey && entry.data.lang !== post.data.lang);
const alternateUrl = alternate ? withLangPrefix(`/${stripLangFromSlug(alternate.slug) || alternate.id}/`, alternate.data.lang) : undefined;
---

<BaseLayout title={seoTitle || title} description={description} image={coverImage?.src || undefined} lang={lang}>
	<div class='container lg:flex gap-10'>
		<main
			class='overflow-hidden grow'
		>
			<article>
				<Prose>
					<div>
						<h1 class='!my-1 leading-tight flex items-center gap-2'>
              <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs uppercase tracking-wide border-zinc-300 dark:border-zinc-700">{lang.toUpperCase()}</span>
              {title}
            </h1>
            <div class='text-sm font-[500] mt-2 sm:mt-0 py-1 md:text-right flex flex-col sm:flex-row gap-3 sm:justify-between sm:items-center'>
              {
                <div class='flex gap-2'>
                  {
                    (tags || [] )?.map((tag: string) => (
                      <a
                        class='border border-zinc-300 dark:border-zinc-700 rounded-2xl
                          text-sm text-zinc-700 dark:text-zinc-300 no-underline px-2 py-0.5
                          transition-all duration-700
                        hover:border-zinc-700 dark:hover:border-zinc-300'
                        href={withLangPrefix(`/tags/${slugify(tag)}/`, lang)}>
                        {tag}
                      </a>
                    ))
                  }
                </div>
              }
              <div>
                {
                  updatedDate ?
                    <>{copy.blogPost.updatedOn} <strong><FormattedDate date={updatedDate} lang={lang} /></strong></>
                  :
                    <>{copy.blogPost.publishedOn} <strong><FormattedDate date={date} lang={lang} /></strong></>
                }
              </div>
            </div>
            {alternateUrl && (
              <div class="mt-2 text-sm">
                <a class="underline" href={alternateUrl}>
                  {lang === 'en' ? 'Leggi in Italiano' : 'Read in English'}
                </a>
              </div>
            )}
					</div>
          <div class='py-3 overflow-hidden'>
            {coverImage && <Image class='rounded-3xl w-full m-0 lg:mb-2' src={coverImage} alt={title} loading='eager' />}
          </div>
					<Content />
				</Prose>
        {
          GISCUS_REPO &&
            <script
              id='giscus-script'
              is:inline
              src='https://giscus.app/client.js'
              data-repo={GISCUS_REPO}
              data-repo-id={GISCUS_REPO_ID}
              data-category={GISCUS_CATEGORY}
              data-category-id={GISCUS_CATEGORY_ID}
              data-mapping='pathname'
              data-strict='0'
              data-reactions-enabled='1'
              data-emit-metadata='0'
              data-input-position='bottom'
              data-theme='preferred_color_scheme'
              data-lang={lang}
              crossorigin='anonymous'
              async></script>
        }

			</article>
		</main>
    <div class='shrink-0 w-[280px] hidden md:block'>
      <div class='mb-4'>
				<AboutTheAuthor lang={lang} />
			</div>
			<TableOfContent headings={headings} lang={lang} />
		</div>
	</div>
</BaseLayout>

<script async is:inline>
	const anchors = document.querySelectorAll('.prose h2[id], .prose h3[id]');
	const links = document.querySelectorAll('nav.toc ul li a');

	function observeToc() {
		if (typeof anchors != 'undefined' && anchors != null && typeof links != 'undefined' && links != null) {
			let scrollTop = window.scrollY;

			// highlight the last scrolled-to: set everything inactive first
			for (const link of links) {
				link.classList.add('border-transparent', 'text-inherit');
				link.classList.remove('bg-[var(--background-surface-color)]', 'border-[var(--soft-border-color)]', 'text-[var(--link-color)]');
			}
			// then iterate backwards, on the first match highlight it and break
			for (var i = anchors.length - 1; i >= 0; i--) {
				if (scrollTop > anchors[i].offsetTop - 80) {
					links[i].classList.remove('border-transparent', 'text-inherit');
					links[i].classList.add('bg-[var(--background-surface-color)]', 'border-[var(--soft-border-color)]', 'text-[var(--link-color)]');
					break;
				}
			}
		}
	}

	window.addEventListener('scroll', (event) => {
		observeToc(event);
	});
	window.addEventListener('hashchange', (event) => {
		observeToc(event);
	});
</script>
