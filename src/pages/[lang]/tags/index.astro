---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import BaseLayout from '@src/layouts/BaseLayout.astro';
import { slugify } from '@src/utils';
import { getUiCopy } from '@src/i18n/ui';
import { resolveLang, SUPPORTED_LANGS, type Lang, withLangPrefix } from '@src/i18n/config';

type BlogPost = CollectionEntry<'blog'>;
type PubEntry = CollectionEntry<'publications'>;
interface Tag {
  value: string;
  label: string;
  postCount: number;
  pubCount: number;
}

function groupTagsByFirstLetter(tags: Tag[]) {
  const grouped = tags.reduce((acc, tag) => {
    const firstLetter = tag.label[0].toUpperCase();
    if (!acc[firstLetter]) {
      acc[firstLetter] = [];
    }
    acc[firstLetter].push(tag);
    return acc;
  }, {} as Record<string, Tag[]>);

  return Object.entries(grouped)
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([letter, tags]) => ({
      letter,
      tags: tags.sort((a, b) => a.label.localeCompare(b.label)),
    }));
}

export function getStaticPaths() {
  return SUPPORTED_LANGS.map((lang: Lang) => ({ params: { lang } }));
}

const lang = resolveLang(Astro.params.lang);
const copy = getUiCopy(lang);

const allPosts: BlogPost[] = (await getCollection('blog')).filter((entry) => entry.data.lang === lang);
const allPubs: PubEntry[] = (await getCollection('publications')).filter((entry) => entry.data.lang === lang);
const mappedTags: { [key: string]: Tag } = {};

for (const post of allPosts) {
  for (const tag of post.data?.tags || []) {
    const tagValue = slugify(tag);
    mappedTags[tagValue] = mappedTags[tagValue] || { value: tagValue, label: tag, postCount: 0, pubCount: 0 };
    mappedTags[tagValue].postCount += 1;
  }
}

for (const pub of allPubs) {
  for (const tag of pub.data?.tags || []) {
    const tagValue = slugify(tag);
    mappedTags[tagValue] = mappedTags[tagValue] || { value: tagValue, label: tag, postCount: 0, pubCount: 0 };
    mappedTags[tagValue].pubCount += 1;
  }
}

const groupedTags = groupTagsByFirstLetter(Object.values(mappedTags));
const title = copy.tags.title;
const description = copy.tags.description;
---

<BaseLayout title={title} description={description} lang={lang}>
  <div class='container'>
    <div class="mb-10">
      <h1 class="text-3xl font-bold mb-2">{title}</h1>
      <p class="text-zinc-700 dark:text-zinc-300 text-lg">{description}</p>
    </div>
    <div>
      {groupedTags.map(({ letter, tags }) => (
        <div class="flex gap-2 border-b dark:border-b-zinc-700 py-3 mb-5 capitalize">
          <h2 class="text-2xl font-bold text-zinc-800 dark:text-zinc-200 w-7 shrink-0">{letter}</h2>
          <div class='flex gap-2 flex-wrap'>
            {
              (tags || [])?.map((tag: Tag) => (
                <a
                  class='border rounded-2xl text-sm no-underline px-3 py-1 transition-all duration-700 hover:opacity-85 bg-zinc-50 text-zinc-800 dark:bg-zinc-900/40 dark:text-zinc-100 dark:border-zinc-700'
                  href={withLangPrefix(`/tags/${slugify(tag.value)}/`, lang)}>
                  {tag.label} ({tag.postCount + tag.pubCount})
                </a>
              ))
            }
          </div>
        </div>
      ))}
    </div>
  </div>
</BaseLayout>
