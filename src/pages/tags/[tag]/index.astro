---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import BaseLayout from '@src/layouts/BaseLayout.astro';
import { slugify, unslugify } from '@src/utils';
import PostsByYear from '@src/components/PostsByYear.astro';
import PublicationItem from '@src/components/PublicationItem.astro';

type BlogPost = CollectionEntry<'blog'>;
type PubEntry = CollectionEntry<'publications'>;

export const getStaticPaths = async () => {
	const allPosts: BlogPost[] = await getCollection('blog');
  const allPubs: PubEntry[] = await getCollection('publications');
	return [
		...new Set(
			[
        ...allPosts.flatMap((post) => post.data.tags || []),
        ...allPubs.flatMap((pub) => pub.data.tags || []),
      ].filter((tag) => !!tag)
		)
	].map((tag) => ({ params: { tag: slugify(tag || '') } }));
};

const { tag } = Astro.params;
const allPosts: BlogPost[] = (await getCollection('blog')).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const taggedPosts = allPosts.filter((post) => post.data.tags?.map((tag) => slugify(tag)).includes(tag || ''));

const allPubs: PubEntry[] = await getCollection('publications');
const taggedPubs = allPubs.filter((pub) => pub.data.tags?.map((tag) => slugify(tag)).includes(tag || ''));

const title = `All content tagged with ${unslugify(tag || '')}`;
const description = `Posts and publications tagged with ${unslugify(tag || '')}.`;
---

<BaseLayout
	title={title}
	description={description}
>
  <div class='container'>
    <div class="mb-10">
      <h1 class="text-3xl font-bold mb-2">{title}</h1>
    </div>
    {
      taggedPosts.length > 0 && (
        <section class="mb-8">
          <h2 class="text-2xl font-semibold mb-4">Articles</h2>
          <PostsByYear posts={taggedPosts}/>
        </section>
      )
    }
    {
      taggedPubs.length > 0 && (
        <section class="mb-8">
          <h2 class="text-2xl font-semibold mb-3">Publications</h2>
          <div>
            {taggedPubs.map((publication) => (
              <PublicationItem publication={publication} />
            ))}
          </div>
        </section>
      )
    }
    {
      taggedPosts.length === 0 && taggedPubs.length === 0 && (
        <p class="text-zinc-700 dark:text-zinc-300">No content found for this tag.</p>
      )
    }
  </div>
</BaseLayout>
